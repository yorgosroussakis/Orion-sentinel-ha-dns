# Two Pi HA Mode - Full High Availability across two hosts
# =========================================================
#
# DEPLOYMENT:
#   On Pi1: docker compose -f stacks/dns/docker-compose.yml --profile two-pi-ha-pi1 up -d
#   On Pi2: docker compose -f stacks/dns/docker-compose.yml --profile two-pi-ha-pi2 up -d
#
# SETUP INSTRUCTIONS:
#   1. Copy this file to the repo root as .env on BOTH Pis
#   2. Set the same values on both Pis EXCEPT for HOST_IP and KEEPALIVED_PRIORITY
#   3. On Pi1: HOST_IP=<Pi1 IP>, KEEPALIVED_PRIORITY=100
#   4. On Pi2: HOST_IP=<Pi2 IP>, KEEPALIVED_PRIORITY=90
#   5. Generate secure passwords with: openssl rand -base64 32
#   6. Run: bash scripts/validate-env.sh to verify your config

#####################################
# DEPLOYMENT MODE
#####################################
# This file is for: Mode C - two-pi-ha
# Description: Primary services on Pi1, secondary services on Pi2, with keepalived VIP
# Use case: Full high availability with automatic failover between two Pis
DEPLOYMENT_MODE=two-pi-ha

#####################################
# NODE CONFIGURATION
#####################################
# HOST_IP: The IP address of THIS node
# *** SET THIS DIFFERENTLY ON EACH PI ***
#   Pi1: HOST_IP=192.168.8.250
#   Pi2: HOST_IP=192.168.8.251
HOST_IP=192.168.8.250

# Hostname for Pi1 (primary host)
PI1_HOSTNAME=pi1-dns

# Hostname for Pi2 (secondary host)
PI2_HOSTNAME=pi2-dns

# IP address of Pi1
PI1_IP=192.168.8.250

# IP address of Pi2
PI2_IP=192.168.8.251

# PRIMARY_DNS_IP and SECONDARY_DNS_IP are used by some scripts
# Set these to match your Pi IPs
PRIMARY_DNS_IP=192.168.8.250
SECONDARY_DNS_IP=192.168.8.251

#####################################
# NETWORK CONFIGURATION
#####################################
# Physical network interface (usually eth0 for Raspberry Pi)
NETWORK_INTERFACE=eth0

# Network subnet in CIDR notation
SUBNET=192.168.8.0/24

# Network gateway (your router's IP)
GATEWAY=192.168.8.1

#####################################
# VIRTUAL IP (VIP) CONFIGURATION
#####################################
# VIP_ADDRESS: The Virtual IP that floats between Pi1 and Pi2
# - This is the IP clients use for DNS queries
# - Must be in the same subnet as your Pis
# - Must NOT be the network address (.0) or broadcast address (.255)
# - Must NOT conflict with any other device or DHCP range
VIP_ADDRESS=192.168.8.249

#####################################
# KEEPALIVED CONFIGURATION
#####################################
# Enable Keepalived for VIP management
KEEPALIVED_ENABLED=true

# KEEPALIVED_PRIORITY: Determines which Pi is MASTER
# *** SET THIS DIFFERENTLY ON EACH PI ***
#   Pi1 (MASTER): KEEPALIVED_PRIORITY=100
#   Pi2 (BACKUP): KEEPALIVED_PRIORITY=90
KEEPALIVED_PRIORITY=100

# Legacy vars for compatibility (same as above)
KEEPALIVED_PRIORITY_PI1=100
KEEPALIVED_PRIORITY_PI2=90

# Virtual Router ID (must be same on both Pis and unique on your network 1-255)
VIRTUAL_ROUTER_ID=51

# VRRP Authentication Password (MUST be the same on both Pis)
# SECURITY: Generate with: openssl rand -base64 20
VRRP_PASSWORD=CHANGE_ME_REQUIRED

# Use unicast VRRP instead of multicast (recommended for most networks)
USE_UNICAST_VRRP=true

#####################################
# PI-HOLE CONFIGURATION
#####################################
# Pi-hole admin password (must be same on both Pis)
# SECURITY: Generate with: openssl rand -base64 32
PIHOLE_PASSWORD=CHANGE_ME_REQUIRED

# Timezone (use your local timezone)
TZ=Europe/London

#####################################
# GRAFANA CONFIGURATION
#####################################
# Grafana admin username
GRAFANA_ADMIN_USER=admin

# Grafana admin password
# SECURITY: Generate with: openssl rand -base64 32
GRAFANA_ADMIN_PASSWORD=CHANGE_ME_REQUIRED

#####################################
# DNS CONFIGURATION
#####################################
# Upstream DNS servers (Unbound services by name)
# Primary Pi-hole uses primary Unbound
PIHOLE_DNS_PRIMARY=unbound_primary#5335
# Secondary Pi-hole uses secondary Unbound
PIHOLE_DNS_SECONDARY=unbound_secondary#5335

#####################################
# SYNCHRONIZATION SETTINGS
#####################################
# Sync interval in seconds (for Pi-hole config sync between Pis)
SYNC_INTERVAL=300

# Gravity Sync mode: "push" (primary to secondary) or "pull" (secondary from primary)
GRAVITY_SYNC_MODE=push

# Gravity Sync frequency (cron format) - Every hour
GRAVITY_SYNC_CRON="0 * * * *"

#####################################
# MONITORING & OBSERVABILITY (Optional)
#####################################
# Deploy monitoring stack? (true/false)
# Recommend: true on Pi1 only to save resources
DEPLOY_MONITORING=true

# Prometheus retention period
PROMETHEUS_RETENTION=30d

#####################################
# SIGNAL NOTIFICATIONS (Optional)
#####################################
# Your phone number registered with Signal (with country code)
SIGNAL_NUMBER=+1234567890

# Recipient phone numbers (comma-separated)
SIGNAL_RECIPIENTS=+1234567890

# Enable notifications for:
NOTIFY_ON_FAILOVER=true
NOTIFY_ON_FAILBACK=true
NOTIFY_ON_SYNC_FAILURE=true
NOTIFY_ON_SERVICE_DOWN=true

#####################################
# DOCKER RESOURCE LIMITS
#####################################
# Pi-hole container limits
PIHOLE_CPU_LIMIT=1.0
PIHOLE_MEM_LIMIT=512M

# Unbound container limits
UNBOUND_CPU_LIMIT=0.5
UNBOUND_MEM_LIMIT=256M

# Keepalived container limits
KEEPALIVED_CPU_LIMIT=0.25
KEEPALIVED_MEM_LIMIT=128M

#####################################
# ADVANCED SETTINGS
#####################################
# DNS query logging
ENABLE_QUERY_LOGGING=true

# DNSSEC validation
ENABLE_DNSSEC=true

# DNS-over-HTTPS (DoH) - via Cloudflared (optional)
ENABLE_DOH=false

# Rate limiting (queries per second per client)
DNS_RATE_LIMIT=100

# Cache size (MB)
DNS_CACHE_SIZE=256

#####################################
# NEXTDNS OVER DOT CONFIGURATION
#####################################
# Unbound now forwards all queries to NextDNS over encrypted DoT.
# This provides privacy-enhanced DNS resolution with filtering capabilities.
#
# DNS Flow: Clients → VIP (Keepalived) → Pi-hole → Unbound → NextDNS DoT
#
# To configure:
# 1. Create a NextDNS profile at https://my.nextdns.io
# 2. Get your profile-specific IPv4 endpoint
# 3. Set NEXTDNS_IPV4 below (must be same on BOTH Pis)
#
# Privacy settings in NextDNS dashboard:
# - Logs: Minimize retention or disable for maximum privacy
# - Storage: Select preferred region/data center

# Enable NextDNS integration
NEXTDNS_ENABLED=true

# NextDNS IPv4 endpoint (replace with your profile-specific IP)
# Default is NextDNS Anycast - for profile-specific, use your assigned IP
NEXTDNS_IPV4=45.90.28.0

# NextDNS IPv6 endpoint (optional, leave empty if not using IPv6)
NEXTDNS_IPV6=

# NextDNS DoT port (default: 853)
NEXTDNS_DOT_PORT=853

# NextDNS hostname for TLS verification
NEXTDNS_HOSTNAME=dns.nextdns.io

#####################################
# SMART DNS / UNBOUND PREFETCH
#####################################
# Enable smarter DNS with prefetching and enhanced caching
# This improves DNS performance by:
# - Prefetching popular records before they expire
# - Larger cache sizes for better hit rates
# - QNAME minimisation for enhanced privacy
# - Aggressive NSEC for reduced queries
# Set to 1 to enable, 0 to disable (default: 0)
# IMPORTANT: Set the same value on BOTH Pis
UNBOUND_SMART_PREFETCH=0

#####################################
# ENCRYPTED DNS GATEWAY (DoH/DoT)
#####################################
# Enable DoH/DoT terminator for "dumb" devices (TVs, consoles, IoT).
# This gateway accepts encrypted DNS queries and forwards them to
# the internal Pi-hole/Unbound VIP, keeping all filtering rules intact.
#
# Before enabling:
# 1. Generate TLS certs: cd stacks/dns/blocky && bash generate-certs.sh
# 2. Set ORION_DOH_DOT_GATEWAY_ENABLED=1
# 3. Deploy with: docker compose --profile doh-dot-gateway up -d
#
# Set to 1 to enable, 0 to disable (default: 0)
# IMPORTANT: Set the same value on BOTH Pis
ORION_DOH_DOT_GATEWAY_ENABLED=0
