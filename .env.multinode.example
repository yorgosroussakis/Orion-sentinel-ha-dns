# =============================================================================
# Two-Pi HA Configuration - Orion Sentinel DNS HA Stack
# =============================================================================
#
# This configuration is for deploying DNS HA across TWO Raspberry Pi nodes.
# Each Pi runs Pi-hole + Unbound + Keepalived in Docker containers.
# A single Virtual IP (VIP) floats between nodes for automatic failover.
#
# DEPLOYMENT ARCHITECTURE:
#   Pi1 (Primary):   Pi-hole + Unbound + Keepalived MASTER
#   Pi2 (Secondary): Pi-hole + Unbound + Keepalived BACKUP
#   VIP: Floats between Pi1 and Pi2 based on health
#
# SETUP STEPS:
#   1. Prepare both Pis with static IPs and hostnames
#   2. Clone this repo to /opt/Orion-sentinel-ha-dns on BOTH nodes
#   3. Copy this file to .env on BOTH nodes
#   4. Edit the "THIS NODE SETTINGS" section differently on each Pi
#   5. Keep all other settings identical on both Pis
#   6. Run install.sh on Pi1, then Pi2
#
# =============================================================================

#####################################
# GLOBAL SETTINGS (Same on both Pis)
#####################################

# Deployment mode - identifies this as a two-node HA setup
DEPLOYMENT_MODE=two-pi-ha

# Timezone for all services
TZ=Europe/London

#####################################
# THIS NODE SETTINGS
# *** EDIT THESE DIFFERENTLY ON EACH PI ***
#####################################

# NODE_ROLE: Identifies this specific node
# Pi1 (Primary):   NODE_ROLE=primary
# Pi2 (Secondary): NODE_ROLE=secondary
NODE_ROLE=primary

# HOST_IP: The IP address of THIS node
# Pi1: HOST_IP=192.168.8.11
# Pi2: HOST_IP=192.168.8.12
# Must be a static IP in your LAN
HOST_IP=192.168.8.11

# Hostname for THIS node
# Pi1: NODE_HOSTNAME=pi1-dns
# Pi2: NODE_HOSTNAME=pi2-dns
NODE_HOSTNAME=pi1-dns

#####################################
# PEER NODE SETTINGS
# (Same on both Pis, describes the other node)
#####################################

# IP address of Pi1 (primary node)
PI1_IP=192.168.8.11

# IP address of Pi2 (secondary node)  
PI2_IP=192.168.8.12

# Hostname of Pi1
PI1_HOSTNAME=pi1-dns

# Hostname of Pi2
PI2_HOSTNAME=pi2-dns

# PEER_IP: IP of the OTHER node
# Pi1: PEER_IP=192.168.8.12 (points to Pi2)
# Pi2: PEER_IP=192.168.8.11 (points to Pi1)
# This is used for unicast VRRP and sync operations
PEER_IP=192.168.8.12

#####################################
# NETWORK CONFIGURATION (Same on both Pis)
#####################################

# Physical network interface (usually eth0 for Raspberry Pi)
# The VIP will be assigned to this interface
NETWORK_INTERFACE=eth0

# Network subnet in CIDR notation
SUBNET=192.168.8.0/24

# Network gateway (your router's IP)
GATEWAY=192.168.8.1

#####################################
# VIP CONFIGURATION (Same on both Pis)
#####################################

# VIP_ADDRESS: The Virtual IP that floats between Pi1 and Pi2
# - ALL LAN clients use ONLY this IP for DNS queries
# - Keepalived manages which node owns the VIP
# - Must be in the same subnet as your Pis
# - Must NOT be .0 (network) or .255 (broadcast)
# - Must NOT conflict with DHCP range or other devices
# - Example: If your network is 192.168.8.0/24, use 192.168.8.249
VIP_ADDRESS=192.168.8.249

#####################################
# KEEPALIVED CONFIGURATION
#####################################

# Enable Keepalived for VIP management
KEEPALIVED_ENABLED=true

# KEEPALIVED_PRIORITY: Determines which Pi is preferred MASTER
# *** SET THIS DIFFERENTLY ON EACH PI ***
# Pi1 (Primary):   KEEPALIVED_PRIORITY=200
# Pi2 (Secondary): KEEPALIVED_PRIORITY=150
# Higher number = preferred MASTER. Pi1 will own VIP by default.
# If Pi1 fails, Pi2 takes over automatically.
KEEPALIVED_PRIORITY=200

# Virtual Router ID (must be same on both nodes, unique on your network 1-255)
# Only change if you have multiple VRRP setups on the same LAN
VIRTUAL_ROUTER_ID=51

# VRRP Authentication Password
# SECURITY: Must be the SAME on both Pis
# Generate a secure password: openssl rand -base64 20
# ⚠️  DO NOT LEAVE AS DEFAULT - CHANGE BEFORE DEPLOYMENT! ⚠️
VRRP_PASSWORD=CHANGE_ME_BEFORE_DEPLOYMENT

# Use unicast VRRP instead of multicast (recommended)
# Unicast works better on networks where multicast is disabled
# When enabled, VRRP heartbeats go directly between PI1_IP and PI2_IP
USE_UNICAST_VRRP=true

# DNS Health Check Settings
# Keepalived checks local Pi-hole via localhost to determine DNS health
# If DNS fails, triggers failover to peer node
DNS_CHECK_IP=127.0.0.1
DNS_CHECK_PORT=53

#####################################
# PI-HOLE CONFIGURATION (Same on both Pis)
#####################################

#
# ⚠️  CRITICAL PRIVACY WARNING ⚠️
#
# This project ONLY supports the following upstream DNS providers:
#   ✅ Unbound (local recursive resolver) - RECOMMENDED for maximum privacy
#   ✅ Only Unbound is supported
#
# DO NOT USE PUBLIC DNS PROVIDERS - They expose your DNS queries!
#   ❌ Google DNS (8.8.8.8, 8.8.4.4)
#   ❌ Cloudflare DNS (1.1.1.1, 1.0.0.1)
#   ❌ OpenDNS (208.67.222.222, 208.67.220.220)
#   ❌ Quad9 (9.9.9.9, 149.112.112.112)
#   ❌ Any other third-party DNS provider
#
# Pi-hole upstreams point to local Unbound containers by default.
# See docs/PIHOLE_CONFIGURATION.md for full privacy rationale.
#

# Pi-hole admin password (must be SAME on both Pis)
# SECURITY: Generate a secure password: openssl rand -base64 32
# ⚠️  DO NOT LEAVE AS DEFAULT - CHANGE BEFORE DEPLOYMENT! ⚠️
PIHOLE_PASSWORD=CHANGE_ME_BEFORE_DEPLOYMENT

# Upstream DNS configuration
# Pi1's Pi-hole uses unbound_primary container
PIHOLE_DNS_PRIMARY=unbound_primary#5335
# Pi2's Pi-hole uses unbound_secondary container
PIHOLE_DNS_SECONDARY=unbound_secondary#5335

#####################################
# UNBOUND CONFIGURATION (Same on both Pis)
#####################################

# Enable smart DNS with prefetching and enhanced caching
# Improves performance by prefetching popular records before expiry
# Set to 1 to enable, 0 to disable
# Must be SAME on both Pis
UNBOUND_SMART_PREFETCH=0

#####################################
# SYNCHRONIZATION SETTINGS
#####################################

# Pi-hole configuration sync between nodes
# Sync interval in seconds (how often to sync Pi-hole settings)
SYNC_INTERVAL=3600

# Auto-update interval in seconds (how often to check for Pi-hole updates)
UPDATE_INTERVAL=86400

# Gravity Sync mode: "push" (primary to secondary) or "pull" (secondary from primary)
GRAVITY_SYNC_MODE=push

# Gravity Sync frequency (cron format) - Every hour
GRAVITY_SYNC_CRON="0 * * * *"

#####################################
# MONITORING & OBSERVABILITY
#####################################

# Deploy monitoring stack (Grafana/Prometheus)?
# Recommendation: Deploy on PRIMARY node only to save resources
# Pi1: DEPLOY_MONITORING=true
# Pi2: DEPLOY_MONITORING=false
DEPLOY_MONITORING=true

# Grafana admin password
# SECURITY: Generate with: openssl rand -base64 32
# ⚠️  DO NOT LEAVE AS DEFAULT - CHANGE BEFORE DEPLOYMENT! ⚠️
GRAFANA_ADMIN_PASSWORD=CHANGE_ME_BEFORE_DEPLOYMENT

# Prometheus retention period
PROMETHEUS_RETENTION=30d

#####################################
# SIGNAL NOTIFICATIONS (Optional)
#####################################

# Your phone number registered with Signal (with country code)
SIGNAL_NUMBER=+1234567890

# Recipient phone numbers (comma-separated)
SIGNAL_RECIPIENTS=+1234567890

# Enable notifications for specific events
NOTIFY_ON_FAILOVER=true
NOTIFY_ON_FAILBACK=true
NOTIFY_ON_SYNC_FAILURE=true
NOTIFY_ON_SERVICE_DOWN=true

#####################################
# AI-WATCHDOG (Optional)
#####################################

# Deploy AI-Watchdog for automatic issue resolution?
# Recommendation: Deploy on PRIMARY node only
DEPLOY_AI_WATCHDOG=true

# Watchdog check interval in seconds
WATCHDOG_CHECK_INTERVAL=30

# Number of consecutive failures before triggering restart
WATCHDOG_RESTART_THRESHOLD=3

# Alert cooldown period in seconds (prevents alert spam)
WATCHDOG_ALERT_COOLDOWN=300

#####################################
# BACKUP CONFIGURATION
#####################################

# Backup retention in days
BACKUP_RETENTION_DAYS=30

# Backup location (local path on each Pi)
BACKUP_PATH=/opt/dns-backups

# Enable automatic backups
AUTO_BACKUP_ENABLED=true

# Backup schedule (cron format) - Daily at 2 AM
BACKUP_CRON="0 2 * * *"

#####################################
# ADVANCED SETTINGS
#####################################

# DNS query logging
ENABLE_QUERY_LOGGING=true

# DNSSEC validation
ENABLE_DNSSEC=true

# DNS-over-HTTPS (DoH) - via Cloudflared (optional)
ENABLE_DOH=false

# Rate limiting (queries per second per client)
DNS_RATE_LIMIT=100

# Cache size (MB)
DNS_CACHE_SIZE=256

#####################################
# DOCKER RESOURCE LIMITS
#####################################

# Pi-hole container limits
PIHOLE_CPU_LIMIT=1.0
PIHOLE_MEM_LIMIT=512M

# Unbound container limits
UNBOUND_CPU_LIMIT=0.5
UNBOUND_MEM_LIMIT=256M

# Keepalived container limits
KEEPALIVED_CPU_LIMIT=0.25
KEEPALIVED_MEM_LIMIT=128M

#####################################
# ENCRYPTED DNS GATEWAY (DoH/DoT)
#####################################

# Enable DoH/DoT gateway for encrypted DNS queries
# Accepts DoH/DoT from clients and forwards to Pi-hole/Unbound
# Before enabling:
#   1. Generate TLS certs: cd stacks/dns/blocky && bash generate-certs.sh
#   2. Set ORION_DOH_DOT_GATEWAY_ENABLED=1
#   3. Deploy with: docker compose --profile doh-dot-gateway up -d
# Set to 1 to enable, 0 to disable
# Must be SAME on both Pis
ORION_DOH_DOT_GATEWAY_ENABLED=0

# =============================================================================
# IMPORTANT NOTES FOR TWO-PI HA DEPLOYMENT
# =============================================================================
#
# DIFFERENT ON EACH PI:
#   - NODE_ROLE (primary vs secondary)
#   - HOST_IP (Pi1's IP vs Pi2's IP)
#   - NODE_HOSTNAME (pi1-dns vs pi2-dns)
#   - KEEPALIVED_PRIORITY (200 on Pi1, 150 on Pi2)
#   - PEER_IP (points to the OTHER node)
#   - DEPLOY_MONITORING (true on Pi1, false on Pi2 to save resources)
#
# MUST BE SAME ON BOTH PIS:
#   - VIP_ADDRESS
#   - VIRTUAL_ROUTER_ID
#   - VRRP_PASSWORD
#   - PIHOLE_PASSWORD
#   - All other passwords
#   - Network settings (SUBNET, GATEWAY, NETWORK_INTERFACE)
#   - All feature flags (ENABLE_*, ORION_*)
#
# VERIFICATION:
#   After setup, verify VIP ownership:
#     On Pi1: ip addr show eth0 | grep 192.168.8.249
#     On Pi2: ip addr show eth0 | grep 192.168.8.249
#   Only one node should show the VIP (the MASTER)
#
#   Test DNS via VIP:
#     dig google.com @192.168.8.249
#
#   Test failover:
#     On Pi1: docker stop keepalived
#     Wait 10 seconds, VIP should move to Pi2
#     DNS should still work via VIP
#
# =============================================================================
