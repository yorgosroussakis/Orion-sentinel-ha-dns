# Orion DNS HA - First-Run Web Wizard

A simple, user-friendly web interface for configuring Orion DNS HA without editing configuration files.

## Overview

This wizard provides a 3-step guided setup for:
- Network configuration (single-node vs HA mode)
- DNS security profile selection
- Initial deployment guidance

Built with Flask for simplicity and minimal dependencies.

## Features

- **Simple Setup**: Just 3 steps to configure your DNS HA stack
- **No YAML Editing**: All configuration through web forms
- **Auto-Detection**: Automatically detects Pi's IP and network interface
- **Profile Selection**: Choose from Family, Standard, or Paranoid DNS filtering
- **Setup Tracking**: Uses `.setup_done` sentinel file to prevent re-running accidentally
- **Mobile-Friendly**: Responsive design works on phones, tablets, and desktops

## Usage

### First-Time Setup

1. **Run the install script** (automatically starts wizard):
   ```bash
   bash scripts/install.sh
   ```

2. **Access the wizard** in your browser:
   ```
   http://<your-pi-ip>:5555
   ```

3. **Follow the 3-step wizard:**
   - Step 1: Welcome - Learn about Orion DNS HA
   - Step 2: Network Configuration - Choose mode and configure network
   - Step 3: Profile Selection - Choose DNS filtering level

4. **Complete setup** and deploy the stack as instructed

### Accessing After Setup

Once setup is complete, the wizard shows a completion page with:
- Next steps for deploying the stack
- Router configuration instructions
- Links to Pi-hole and Grafana interfaces
- Option to re-apply DNS profiles

Access: `http://<your-pi-ip>:5555`

### Re-Running the Wizard

To start over:

```bash
# Remove the setup sentinel file
rm wizard/.setup_done

# Restart the wizard container
docker compose -f stacks/dns/docker-compose.yml restart dns-wizard

# Access at http://<your-pi-ip>:8080
```

## Architecture

### Technology Stack

- **Backend**: Flask (Python web framework)
- **Frontend**: HTML5 + CSS3 + Vanilla JavaScript
- **Templating**: Jinja2
- **Container**: Docker (official Python 3.11 slim image)

### File Structure

```
wizard/
├── app.py                  # Flask application (main logic)
├── templates/              # HTML templates
│   ├── welcome.html        # Step 1: Welcome page
│   ├── network.html        # Step 2: Network configuration
│   ├── profile.html        # Step 3: Profile selection
│   └── done.html           # Completion page
├── static/
│   └── style.css           # Styling
├── requirements.txt        # Python dependencies
├── Dockerfile              # Container build definition
└── .setup_done             # Sentinel file (created after setup)
```

### API Endpoints

- `GET /` - Main router (redirects based on setup status)
- `GET /welcome` - Welcome page
- `GET /network` - Network configuration page
- `POST /api/network` - Save network configuration
- `GET /profile` - Profile selection page
- `POST /api/profile` - Apply selected profile
- `GET /done` - Setup completion page
- `POST /api/reapply-profile` - Re-apply profile after setup

## Configuration

### Environment Variables

The wizard reads and writes to `stacks/dns/.env`:

**Generated by wizard:**
- `HOST_IP` - Pi's IP address
- `DNS_VIP` - Virtual IP (or Pi IP in single-node)
- `VIP_ADDRESS` - Same as DNS_VIP
- `NODE_ROLE` - MASTER or BACKUP
- `NETWORK_INTERFACE` - Network interface name
- `PIHOLE_PASSWORD` - Pi-hole admin password
- `DNS_PROFILE` - Selected security profile

**Used for deployment:**
- Docker Compose files use these values
- `scripts/apply-profile.py` uses DNS_PROFILE

### Profiles

The wizard offers 3 DNS security profiles:

- **Standard** - Balanced ad/tracker blocking + malware protection
- **Family** - Standard + adult content filtering
- **Paranoid** - Maximum privacy (may break some sites)

Profile definitions are in `profiles/*.yml`.

## Development

### Running Locally (Outside Docker)

```bash
cd wizard

# Install dependencies
pip3 install -r requirements.txt

# Run the app
python3 app.py

# Access at http://localhost:5555
```

### Building the Docker Image

```bash
# From repository root
docker build -t orion-dns-wizard wizard/

# Run standalone
docker run -p 8080:8080 \
  -v $(pwd)/wizard:/app:ro \
  -v $(pwd)/stacks/dns/.env:/app/stacks/dns/.env \
  -v $(pwd)/profiles:/app/profiles:ro \
  orion-dns-wizard
```

### Running in Docker Compose

The wizard is automatically included in `stacks/dns/docker-compose.yml`:

```bash
# Start just the wizard
docker compose -f wizard/docker-compose.yml up -d

# View logs
docker logs -f rpi-dns-setup-ui

# Stop the wizard
docker compose -f wizard/docker-compose.yml down
```

## Troubleshooting

### Wizard Not Accessible

**Check if running:**
```bash
docker ps | grep rpi-dns-setup-ui
```

**Start if not running:**
```bash
cd wizard
docker compose up -d
```

**Check logs:**
```bash
docker logs rpi-dns-setup-ui
```

### Port 5555 Already in Use

Edit `wizard/docker-compose.yml` and change the port:

```yaml
setup-ui:
  ports:
    - "8888:5555"  # Changed from 5555:5555
```

Then access at `http://<pi-ip>:8888`

### Configuration Not Saving

**Check .env file permissions:**
```bash
ls -la stacks/dns/.env
```

**Check wizard has write access:**
```bash
# Ensure the mounted .env is writable
chmod 664 stacks/dns/.env
```

**Check wizard logs for errors:**
```bash
docker logs rpi-dns-setup-ui | grep -i error
```

### "Setup Already Completed" Message

This is normal if you've already run the wizard. To re-run:

```bash
rm wizard/.setup_done
```

Then refresh your browser.

## Security Considerations

### Passwords

- The wizard generates secure random passwords for Grafana and VRRP
- User sets Pi-hole password (minimum 8 characters enforced)
- Passwords are stored in `.env` (should be protected with file permissions)

### Network Access

- The wizard listens on port 8080 on all interfaces (`0.0.0.0`)
- Only accessible from your local network (not exposed to internet)
- No authentication required (assumes trusted local network)

**Important:** Do not expose port 8080 to the internet!

### Sensitive Data

- `.env` file contains passwords and should be protected
- The wizard does not log passwords
- Setup sentinel (`.setup_done`) prevents accidental re-configuration

## Disabling the Wizard

After initial setup, you can disable the wizard:

### Option 1: Stop the Container

```bash
cd wizard
docker compose down
```

### Option 2: Remove from Compose File

The wizard runs independently in its own directory, so just don't start it.

### Option 3: Don't Start It

Simply don't run the wizard commands after initial setup is complete.

## Contributing

When modifying the wizard:

1. **Test thoroughly** - Wizard affects initial setup experience
2. **Keep it simple** - No complex dependencies or frameworks
3. **Validate input** - Check all user input on both client and server
4. **Update docs** - Keep this README and `docs/first-run-wizard.md` in sync

## See Also

- **[First-Run Wizard Guide](../docs/first-run-wizard.md)** - User documentation
- **[Single-Pi Installation](../docs/install-single-pi.md)** - Manual installation
- **[Two-Pi HA Installation](../docs/install-two-pi-ha.md)** - HA setup guide
- **[DNS Profiles](../docs/profiles.md)** - Profile details
