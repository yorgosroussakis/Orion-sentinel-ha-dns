# Orion Sentinel Compose Configuration
# Do not use deprecated 'version:' key - modern compose spec doesn't require it
services:
  pihole_unbound:
    image: ghcr.io/mpgirro/docker-pihole-unbound:2025.03.0
    container_name: pihole_unbound
    profiles:
      - single-node
      - two-node-ha-primary
      - two-node-ha-backup
    network_mode: host
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    environment:
      TZ: ${TZ:-UTC}
      HOSTNAME: ${HOSTNAME:-orion-dns}
      DOMAIN_NAME: ${DOMAIN_NAME:-lan}
      WEBPASSWORD: ${WEBPASSWORD:-changeme}
      FTLCONF_webserver_api_password: ${FTLCONF_webserver_api_password:-}
      FTLCONF_dns_upstreams: ${FTLCONF_dns_upstreams:-127.0.0.1#5335}
      FTLCONF_dns_dnssec: ${FTLCONF_dns_dnssec:-true}
      FTLCONF_local_ipv4: ${NODE_IP:-192.168.8.249}
      DNSMASQ_LISTENING: ${DNSMASQ_LISTENING:-all}
      REV_SERVER: ${REV_SERVER:-true}
      REV_SERVER_TARGET: ${REV_SERVER_TARGET:-192.168.8.1}
      REV_SERVER_DOMAIN: ${REV_SERVER_DOMAIN:-lan}
      REV_SERVER_CIDR: ${REV_SERVER_CIDR:-192.168.8.0/24}
      # Optional: DNS over TLS upstreams for Unbound (disabled by default for local recursion)
      # If you want DoT forwarding, use NextDNS - see unbound/nextdns-forward.conf
      UNBOUND_FORWARD_TLS: ${UNBOUND_FORWARD_TLS:-}
      UNBOUND_FORWARD_ZONES: ${UNBOUND_FORWARD_ZONES:-}
      # Optional: Redis caching support if enabled in the upstream image
      REDIS_ENABLE: ${REDIS_ENABLE:-false}
      REDIS_SERVER: ${REDIS_SERVER:-redis:6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
    volumes:
      - ./pihole/etc-pihole:/etc/pihole
      - ./pihole/etc-dnsmasq.d:/etc/dnsmasq.d
      - ./pihole/var-log:/var/log/pihole
      # Optional: NextDNS DoT forwarding config
      # If the file exists, Unbound forwards to NextDNS over DoT.
      # If absent/unmounted, Unbound performs full local recursive resolution.
      - ./unbound/nextdns-forward.conf:/etc/unbound/unbound.conf.d/nextdns-forward.conf:ro

  keepalived:
    build:
      context: ./keepalived
    container_name: keepalived
    profiles:
      - two-node-ha-primary
      - two-node-ha-backup
    network_mode: host
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      NODE_ROLE: ${NODE_ROLE:-MASTER}
      KEEPALIVED_PRIORITY: ${KEEPALIVED_PRIORITY:-200}
      ROUTER_ID: ${ROUTER_ID:-orion-dns-ha}
      VIP_ADDRESS: ${VIP_ADDRESS:-192.168.8.250}
      VIP_NETMASK: ${VIP_NETMASK:-32}
      NETWORK_INTERFACE: ${NETWORK_INTERFACE:-eth1}
      VIRTUAL_ROUTER_ID: ${VIRTUAL_ROUTER_ID:-51}
      VRRP_PASSWORD: ${VRRP_PASSWORD:-oriondns}
      USE_UNICAST_VRRP: ${USE_UNICAST_VRRP:-true}
      PEER_IP: ${PEER_IP:-}
      UNICAST_SRC_IP: ${UNICAST_SRC_IP:-}
      CHECK_DNS_TARGET: ${CHECK_DNS_TARGET:-127.0.0.1}
      CHECK_DNS_FQDN: ${CHECK_DNS_FQDN:-github.com}
      CHECK_INTERVAL: ${CHECK_INTERVAL:-5}
      CHECK_TIMEOUT: ${CHECK_TIMEOUT:-3}
      CHECK_WEIGHT: ${CHECK_WEIGHT:--20}
      CHECK_FALL: ${CHECK_FALL:-2}
      CHECK_RISE: ${CHECK_RISE:-2}
      # Prometheus Pushgateway integration (optional)
      PROM_PUSHGATEWAY_URL: ${PROM_PUSHGATEWAY_URL:-}
      PROM_JOB_NAME: ${PROM_JOB_NAME:-orion_dns_ha}
      PROM_INSTANCE_LABEL: ${PROM_INSTANCE_LABEL:-}
    volumes:
      - ./keepalived/config:/etc/keepalived

  # Monitoring Exporters
  node_exporter:
    image: prom/node-exporter:v1.8.2
    container_name: node_exporter
    profiles:
      - exporters
    network_mode: host
    restart: unless-stopped
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/host'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host:ro
    pid: host

  # NetSec profile node-exporter with non-conflicting port
  netsec_node_exporter:
    image: prom/node-exporter:v1.8.2
    container_name: netsec_node_exporter
    profiles:
      - netsec
      - netsec-plus-evebox
    restart: unless-stopped
    ports:
      - "19100:9100"
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/host'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host:ro
    pid: host

  pihole_exporter:
    image: ekofr/pihole-exporter:v0.4.0
    container_name: pihole_exporter
    profiles:
      - exporters
    network_mode: host
    restart: unless-stopped
    environment:
      PIHOLE_HOSTNAME: ${NODE_IP:-127.0.0.1}
      PIHOLE_PORT: 80
      PIHOLE_PASSWORD: ${WEBPASSWORD:-changeme}
      INTERVAL: 30s
      PORT: 9617

  promtail:
    image: grafana/promtail:3.0.0
    container_name: promtail
    profiles:
      - exporters
    network_mode: host
    restart: unless-stopped
    environment:
      - LOKI_URL=${LOKI_URL:-http://192.168.8.100:3100/loki/api/v1/push}
      - HOSTNAME=${HOSTNAME:-orion-dns}
    volumes:
      - ./promtail/config.yml:/etc/promtail/config.yml:ro
      - ./pihole/var-log:/var/log/pihole:ro
      - /var/log/syslog:/var/log/syslog:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command:
      - "-config.file=/etc/promtail/config.yml"
      - "-config.expand-env=true"

  # NetSec profile promtail for Suricata logs
  netsec_promtail:
    image: grafana/promtail:3.0.0
    container_name: netsec_promtail
    profiles:
      - netsec
      - netsec-plus-evebox
    restart: unless-stopped
    environment:
      - LOKI_URL=${LOKI_URL:-http://192.168.8.100:3100/loki/api/v1/push}
      - HOSTNAME=${HOSTNAME:-orion-netsec}
    volumes:
      - ./promtail/netsec-config.yml:/etc/promtail/config.yml:ro
      - /mnt/orion-nvme-netsec/suricata/logs:/var/log/suricata:ro
      - /var/log/syslog:/var/log/syslog:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command:
      - "-config.file=/etc/promtail/config.yml"
      - "-config.expand-env=true"

  # =====================================================
  # NetSec Services - Network Security Monitoring
  # =====================================================
  # Use with profile: netsec or netsec-plus-evebox
  # Example: docker compose --profile netsec-plus-evebox up -d

  # Suricata IDS - Network intrusion detection
  suricata:
    image: jasonish/suricata:7.0.6
    container_name: suricata
    profiles:
      - netsec
      - netsec-plus-evebox
    network_mode: host
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    environment:
      TZ: ${TZ:-UTC}
    volumes:
      # Persistent config under NVMe mount
      - /mnt/orion-nvme-netsec/suricata/etc:/etc/suricata
      # Rules from suricata-update
      - /mnt/orion-nvme-netsec/suricata/lib:/var/lib/suricata
      # Logs including eve.json
      - /mnt/orion-nvme-netsec/suricata/logs:/var/log/suricata
    command:
      - -i
      - ${SURICATA_INTERFACE:-eth1}
      - --init-errors-fatal

  # cAdvisor - Container metrics with non-conflicting port
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: cadvisor
    profiles:
      - netsec
      - netsec-plus-evebox
    restart: unless-stopped
    privileged: true
    ports:
      - "18080:8080"
    devices:
      - /dev/kmsg
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro

  # EveBox - Suricata alert management UI
  evebox:
    image: jasonish/evebox:0.18.2
    container_name: evebox
    profiles:
      - netsec-plus-evebox
    restart: unless-stopped
    ports:
      - "5636:5636"
    environment:
      # Admin password can be set via EVEBOX_AUTHENTICATION_REQUIRED and EVEBOX_DATA_DIRECTORY
      # See docs/netsec-node.md for setting admin password
      EVEBOX_AUTHENTICATION_REQUIRED: ${EVEBOX_AUTH_REQUIRED:-false}
    volumes:
      # Read Suricata eve.json from logs directory
      - /mnt/orion-nvme-netsec/suricata/logs:/var/log/suricata:ro
      # EveBox data persistence
      - evebox-data:/var/lib/evebox
    command:
      - server
      - --input
      - /var/log/suricata/eve.json
      - --datastore
      - sqlite
      - --data-directory
      - /var/lib/evebox

volumes:
  evebox-data:
    driver: local
