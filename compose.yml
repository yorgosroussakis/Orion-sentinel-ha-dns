# Orion Sentinel HA DNS - Production-Ready Docker Compose
# ========================================================
#
# High-availability DNS with Pi-hole + Unbound + DoT + Redis
# Using upstream: https://github.com/mpgirro/docker-pihole-unbound
#
# Features:
#   ✅ Pi-hole ad blocking (network-wide)
#   ✅ DNS over TLS encryption (DoT to Quad9)
#   ✅ Redis caching (sub-millisecond responses)
#   ✅ Universal compatibility (ARM32/ARM64/AMD64)
#   ✅ Enterprise performance (DNSSEC validation)
#   ✅ Two-node VRRP HA with keepalived
#   ✅ Prometheus metrics exporters for monitoring integration
#
# Profiles:
#   single-node         - Pi-hole+Unbound only (no HA)
#   two-node-ha-primary - Pi-hole+Unbound + Keepalived MASTER (Node A)
#   two-node-ha-backup  - Pi-hole+Unbound + Keepalived BACKUP (Node B)
#   exporters           - Prometheus exporters for CoreServices/monitoring integration
#
# Quick Start:
#   Single node:  docker compose --profile single-node up -d
#   Primary HA:   docker compose --profile two-node-ha-primary up -d
#   Backup HA:    docker compose --profile two-node-ha-backup up -d
#   With metrics: docker compose --profile two-node-ha-primary --profile exporters up -d
#
# Network Defaults (Raspberry Pi 5 homelab):
#   Node A (Primary): 192.168.8.249
#   Node B (Backup):  192.168.8.243
#   VIP:              192.168.8.250/24 on eth1
#
# Integration:
#   - CoreServices: Prometheus scrapes :9100 (node), :9617 (pihole)
#   - NetSecMon: Ships logs to Loki via Promtail
#   - SPoG: Centralized dashboards on Dell CoreSrv

services:
  # ===========================================================================
  # Pi-hole + Unbound (Single Container)
  # ===========================================================================
  # Using mpgirro/docker-pihole-unbound for:
  #   - Pi-hole ad blocking with curated blocklists
  #   - Unbound recursive resolver with DNSSEC
  #   - DNS over TLS (DoT) to Quad9 for privacy
  #   - Redis caching for sub-millisecond responses
  #   - Cross-arch support (ARM32/ARM64/AMD64)
  # ===========================================================================
  pihole_unbound:
    image: ghcr.io/mpgirro/docker-pihole-unbound:latest
    container_name: pihole_unbound
    hostname: pihole-unbound
    profiles:
      - single-node
      - two-node-ha-primary
      - two-node-ha-backup
    network_mode: host
    cap_add:
      - NET_ADMIN
    environment:
      # Timezone
      TZ: ${TZ:-Europe/London}
      # Pi-hole web password (required)
      WEBPASSWORD: ${PIHOLE_PASSWORD:?PIHOLE_PASSWORD must be set}
      # Listen on all interfaces (required for VIP)
      DNSMASQ_LISTENING: all
      # Pi-hole theme
      WEBTHEME: ${PIHOLE_THEME:-default-dark}
      # Temperature unit
      TEMPERATUREUNIT: c
      # DNS over TLS - enable DoT to Quad9
      DOT_ENABLED: ${DOT_ENABLED:-true}
      DOT_UPSTREAM: ${DOT_UPSTREAM:-9.9.9.9@853#dns.quad9.net}
      # Redis caching for sub-millisecond responses
      REDIS_ENABLED: ${REDIS_ENABLED:-true}
      # DNSSEC validation
      DNSSEC: ${DNSSEC:-true}
      # IPv6 (disable if not needed)
      IPv6: ${IPV6:-false}
    volumes:
      - pihole_config:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
      - pihole_logs:/var/log/pihole
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "-p", "53", "localhost", "+short", "+time=2"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # Keepalived - VRRP for VIP Management (Primary Node)
  # ===========================================================================
  # Based on: https://github.com/acassen/keepalived
  # Manages VIP 192.168.8.250/24 on eth1 floating between nodes
  # ===========================================================================
  keepalived_primary:
    build:
      context: ./keepalived
      dockerfile: Dockerfile
    container_name: keepalived
    hostname: keepalived-primary
    profiles:
      - two-node-ha-primary
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_BROADCAST
      - NET_RAW
    environment:
      NODE_ROLE: MASTER
      KEEPALIVED_PRIORITY: ${KEEPALIVED_PRIORITY:-200}
      VIP_ADDRESS: ${VIP_ADDRESS:?VIP_ADDRESS must be set}
      VIP_NETMASK: ${VIP_NETMASK:-24}
      NETWORK_INTERFACE: ${NETWORK_INTERFACE:-eth1}
      VIRTUAL_ROUTER_ID: ${VIRTUAL_ROUTER_ID:-51}
      VRRP_PASSWORD: ${VRRP_PASSWORD:?VRRP_PASSWORD must be set}
      PEER_IP: ${PEER_IP:-}
      USE_UNICAST_VRRP: ${USE_UNICAST_VRRP:-true}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-x", "keepalived"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      pihole_unbound:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"

  # ===========================================================================
  # Keepalived - VRRP for VIP Management (Backup Node)
  # ===========================================================================
  keepalived_backup:
    build:
      context: ./keepalived
      dockerfile: Dockerfile
    container_name: keepalived
    hostname: keepalived-backup
    profiles:
      - two-node-ha-backup
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_BROADCAST
      - NET_RAW
    environment:
      NODE_ROLE: BACKUP
      KEEPALIVED_PRIORITY: ${KEEPALIVED_PRIORITY:-150}
      VIP_ADDRESS: ${VIP_ADDRESS:?VIP_ADDRESS must be set}
      VIP_NETMASK: ${VIP_NETMASK:-24}
      NETWORK_INTERFACE: ${NETWORK_INTERFACE:-eth1}
      VIRTUAL_ROUTER_ID: ${VIRTUAL_ROUTER_ID:-51}
      VRRP_PASSWORD: ${VRRP_PASSWORD:?VRRP_PASSWORD must be set}
      PEER_IP: ${PEER_IP:-}
      USE_UNICAST_VRRP: ${USE_UNICAST_VRRP:-true}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-x", "keepalived"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      pihole_unbound:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"

  # ===========================================================================
  # NODE EXPORTER - System Metrics for Prometheus
  # Profile: exporters (optional)
  # 
  # Exposes system metrics (CPU, memory, disk, network) for CoreServices
  # Access: http://<HOST_IP>:9100/metrics
  # ===========================================================================
  node_exporter:
    image: prom/node-exporter:latest
    container_name: node_exporter
    hostname: node-exporter
    profiles:
      - exporters
    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    network_mode: host
    pid: host
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host:ro,rslave
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # ===========================================================================
  # PIHOLE EXPORTER - Pi-hole Metrics for Prometheus
  # Profile: exporters (optional)
  # 
  # Exposes Pi-hole statistics as Prometheus metrics
  # Access: http://<HOST_IP>:9617/metrics
  # ===========================================================================
  pihole_exporter:
    image: ekofr/pihole-exporter:latest
    container_name: pihole_exporter
    hostname: pihole-exporter
    profiles:
      - exporters
    network_mode: host
    environment:
      PIHOLE_HOSTNAME: 127.0.0.1
      PIHOLE_PORT: 80
      PIHOLE_PASSWORD: ${PIHOLE_PASSWORD}
      INTERVAL: 30s
      PORT: 9617
    restart: unless-stopped
    depends_on:
      pihole_unbound:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # ===========================================================================
  # PROMTAIL - Log Shipping to Loki (for SPoG/CoreServices integration)
  # Profile: exporters (optional)
  # 
  # Ships Pi-hole logs to centralized Loki on CoreServices/Dell
  # Configure LOKI_URL in .env to point to your Loki instance
  # ===========================================================================
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    hostname: promtail
    profiles:
      - exporters
    network_mode: host
    volumes:
      - pihole_logs:/var/log/pihole:ro
      - ./promtail-config.yml:/etc/promtail/config.yml:ro
    command: -config.file=/etc/promtail/config.yml
    restart: unless-stopped
    depends_on:
      pihole_unbound:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

# ===========================================================================
# Volumes
# ===========================================================================
volumes:
  # Pi-hole configuration and data
  pihole_config:
    driver: local
  # Pi-hole dnsmasq configuration
  pihole_dnsmasq:
    driver: local
  # Pi-hole logs (for Promtail shipping)
  pihole_logs:
    driver: local
