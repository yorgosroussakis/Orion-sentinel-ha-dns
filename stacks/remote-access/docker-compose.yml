# Remote Access Stack - User-Friendly Options
# Includes: Tailscale (easy), Cloudflare Tunnel (web), and WireGuard (advanced)

services:
  # Tailscale - Easy mesh VPN for end users (RECOMMENDED)
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    hostname: ${TAILSCALE_HOSTNAME:-rpi-dns-stack}
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - ./tailscale/state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_ROUTES=${TAILSCALE_ROUTES:-192.168.8.0/24}
      - TS_EXTRA_ARGS=--advertise-tags=tag:homelab --accept-routes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "tailscale", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    networks:
      - remote_access_net
    profiles:
      - tailscale

  # Cloudflare Tunnel - Easy HTTPS access for web services
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    hostname: cloudflared
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    networks:
      - remote_access_net
      - proxy_net
    profiles:
      - cloudflare

  # WireGuard - Advanced VPN option (for power users)
  wireguard:
    image: linuxserver/wireguard:latest
    container_name: wireguard
    hostname: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-Europe/Amsterdam}
      - SERVERURL=${WG_SERVER_URL:-auto}
      - SERVERPORT=${WG_SERVER_PORT:-51820}
      - PEERS=${WG_PEERS:-3}
      - PEERDNS=${WG_PEER_DNS:-192.168.8.251}
      - INTERNAL_SUBNET=${WG_INTERNAL_SUBNET:-10.13.13.0}
      - ALLOWEDIPS=${WG_ALLOWED_IPS:-0.0.0.0/0}
      - LOG_CONFS=${WG_LOG_CONFS:-true}
    volumes:
      - ./wireguard/config:/config
      - /lib/modules:/lib/modules:ro
    ports:
      - "${WG_SERVER_PORT:-51820}:51820/udp"
      - "5000:5000"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "test", "-f", "/config/wg_confs/wg0.conf"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    networks:
      - remote_access_net
    profiles:
      - wireguard

  # WireGuard-UI (only needed if using WireGuard)
  wireguard-ui:
    image: ngoduykhanh/wireguard-ui:latest
    container_name: wireguard-ui
    hostname: wireguard-ui
    depends_on:
      - wireguard
    cap_add:
      - NET_ADMIN
    network_mode: service:wireguard
    environment:
      - SENDGRID_API_KEY=${SENDGRID_API_KEY:-}
      - EMAIL_FROM_ADDRESS=${EMAIL_FROM:-}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-WireGuard}
      - SESSION_SECRET=${WGUI_SESSION_SECRET}
      - WGUI_USERNAME=${WGUI_USERNAME:-admin}
      - WGUI_PASSWORD=${WGUI_PASSWORD}
      - WGUI_ENDPOINT_ADDRESS=${WG_SERVER_URL:-auto}
      - WGUI_DNS=${WG_PEER_DNS:-192.168.8.251}
      - WGUI_MTU=${WGUI_MTU:-1420}
      - WGUI_PERSISTENT_KEEPALIVE=${WGUI_PERSISTENT_KEEPALIVE:-25}
      - WGUI_FORWARD_MARK=${WGUI_FORWARD_MARK:-0xca6c}
      - WGUI_CONFIG_FILE_PATH=/config/wg_confs/wg0.conf
      - WGUI_MANAGE_START=true
      - WGUI_MANAGE_RESTART=true
    volumes:
      - ./wireguard-ui/db:/app/db
      - ./wireguard/config:/config
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: 50m
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    profiles:
      - wireguard

  # Nginx Proxy Manager - Useful for all remote access methods
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    hostname: nginx-proxy-manager
    ports:
      - "80:80"
      - "443:443"
      - "81:81"
    environment:
      - DB_SQLITE_FILE=/data/database.sqlite
      - DISABLE_IPV6=true
    volumes:
      - ./nginx-proxy-manager/data:/data
      - ./nginx-proxy-manager/letsencrypt:/etc/letsencrypt
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/bin/check-health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    networks:
      - remote_access_net
      - proxy_net

networks:
  remote_access_net:
    driver: bridge
    name: remote_access_net
  proxy_net:
    driver: bridge
    name: proxy_net
