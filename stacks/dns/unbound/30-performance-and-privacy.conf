# Unbound Performance and Privacy Enhancement Configuration
# 
# This modular configuration file adds advanced performance tuning,
# prefetching, and privacy hardening to the base Unbound configuration.
#
# Enable by setting UNBOUND_SMART_PREFETCH=1 in your .env file.
#
# Features:
# - Prefetch: Proactively refreshes popular DNS records before expiry
# - Enhanced caching: Larger caches with optimized TTL settings
# - DNSSEC hardening: Strengthened DNSSEC validation
# - QNAME minimisation: Enhanced privacy via query name minimisation
# - Serve expired: Faster perceived response times during cache refresh
#
# Memory Usage: Approximately 448MB at maximum cache utilization
# Suitable for: Raspberry Pi 4/5 with 2-8GB RAM

server:
    ###########################################
    # PREFETCHING CONFIGURATION
    ###########################################
    # Prefetch popular records before they expire
    # This improves cache hit rates and reduces latency for frequently-accessed domains
    prefetch: yes
    
    # Prefetch DNSKEY records for DNSSEC validation
    # Improves DNSSEC performance by proactively fetching keys
    prefetch-key: yes

    ###########################################
    # CACHE SIZE TUNING
    ###########################################
    # Optimized for Raspberry Pi 4/5 with 2-8GB RAM
    # Total maximum cache usage: ~448MB
    
    # Message cache: Stores DNS responses
    # 128MB provides storage for ~500K-1M cached responses
    msg-cache-size: 128m
    
    # RRset cache: Stores resource record sets
    # Should be roughly 2x msg-cache-size for optimal performance
    rrset-cache-size: 256m
    
    # Key cache: Stores DNSSEC keys for validation
    # 64MB is generous for key storage
    key-cache-size: 64m

    ###########################################
    # TTL (TIME TO LIVE) TUNING
    ###########################################
    # Minimum TTL: Keep useful records at least 60 seconds
    # Prevents excessive upstream queries for low-TTL records
    cache-min-ttl: 60
    
    # Maximum TTL: Cap at 1 day (86400 seconds)
    # Prevents stale records from persisting too long
    cache-max-ttl: 86400
    
    # Negative cache TTL: NXDOMAIN responses cached up to 1 hour
    # Reduces repeated queries for non-existent domains
    cache-max-negative-ttl: 3600

    ###########################################
    # PRIVACY HARDENING
    ###########################################
    # QNAME minimisation: Only send minimum necessary query name to each server
    # Improves privacy by not revealing full query to intermediate nameservers
    qname-minimisation: yes
    
    # Strict QNAME minimisation: Fall back if minimised query fails
    # Some authoritative servers may not support this
    qname-minimisation-strict: yes

    ###########################################
    # DNSSEC HARDENING
    ###########################################
    # Harden against DNSSEC stripping attacks
    # Requires DNSSEC validation for domains that should have it
    harden-dnssec-stripped: yes
    
    # Harden below NXDOMAIN: Validate domains under NXDOMAIN responses
    # Prevents cache poisoning via NXDOMAIN responses
    harden-below-nxdomain: yes
    
    # Harden referral path: Validate glue records and referrals
    # Additional protection against cache poisoning
    harden-referral-path: yes
    
    # Aggressive NSEC: Use cached NSEC records to deny existence
    # Reduces queries for non-existent domains
    aggressive-nsec: yes

    ###########################################
    # SERVE EXPIRED CONFIGURATION
    ###########################################
    # Enable serving slightly expired records while requerying
    # Improves perceived response times during cache refresh
    serve-expired: yes
    
    # Maximum age of expired record to serve (180 seconds)
    # Limits how stale a record can be before refusing to serve it
    serve-expired-ttl: 180
    
    # TTL to return for expired records (30 seconds)
    # Client will retry sooner to get fresh data
    serve-expired-reply-ttl: 30
    
    # Timeout before serving expired record while waiting for upstream (180ms)
    # If upstream is slow, serve stale data quickly
    serve-expired-client-timeout: 180
