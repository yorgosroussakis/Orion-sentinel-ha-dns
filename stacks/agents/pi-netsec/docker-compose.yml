# Pi NetSec Agent - Docker Compose Configuration
# Ships Suricata, AI, and NSM logs to Dell CoreSrv Loki (SPoG mode)
#
# This is part of the Single Pane of Glass (SPoG) architecture where:
# - Dell CoreSrv hosts centralized observability (Loki, Grafana, Prometheus, Traefik, Authelia)
# - NetSec Pi runs this Promtail agent to ship security logs to Dell
# - DNS Pi runs a similar agent for DNS logs
#
# Prerequisites:
# 1. Copy promtail-config.example.yml to promtail-config.yml
# 2. Update the Dell CoreSrv IP in promtail-config.yml
# 3. Ensure firewall allows NetSec Pi -> Dell port 3100
# 4. Set LOKI_URL in .env or export it before running
#
# Usage:
#   docker compose up -d

version: '3.8'

services:
  # Promtail - Log shipping agent to Dell CoreSrv
  promtail:
    image: grafana/promtail:2.9.5
    container_name: pi-netsec-agent
    restart: unless-stopped

    command:
      - '-config.file=/etc/promtail/config.yml'

    volumes:
      # Promtail configuration
      - ./promtail-config.yml:/etc/promtail/config.yml:ro

      # System logs
      - /var/log:/var/log:ro

      # Docker container logs
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Suricata logs (adjust path based on deployment)
      # If Suricata runs in Docker, use named volume
      # If Suricata runs on host, use host path
      # - /var/log/suricata:/var/log/suricata:ro
      # - suricata-logs:/var/log/suricata:ro

      # AI service logs (if using file logging)
      # - ./ai-service/logs:/var/log/ai-service:ro

      # Threat intel logs (if using file logging)
      # - ./threat-intel/logs:/var/log/threat-intel:ro

    environment:
      # Override Loki URL via environment variable (optional)
      # This is useful for testing without modifying the config file
      - LOKI_URL=${LOKI_URL:-http://192.168.8.100:3100}

    ports:
      # Promtail metrics endpoint (optional, for monitoring)
      - "9080:9080"

    networks:
      - nsm_net

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9080/ready"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Resource limits for Raspberry Pi
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

    labels:
      # Metadata labels
      - "com.orion.stack=netsec-ai"
      - "com.orion.component=log-agent"
      - "com.orion.role=observability"
      - "com.orion.mode=spog"

# Networks
networks:
  # Connect to the NSM stack network to access container logs
  nsm_net:
    external: true
    # If nsm_net doesn't exist, create it with:
    # docker network create nsm_net

# Volumes (optional - uncomment if using named volumes)
# volumes:
#   suricata-logs:
#     external: true
