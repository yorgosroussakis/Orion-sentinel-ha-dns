# Promtail Configuration for Pi NetSec Agent
# Ships Suricata IDS, AI, and NSM logs to Dell CoreSrv Loki (SPoG mode)
#
# This configuration is designed for the Single Pane of Glass (SPoG) architecture
# where the Dell CoreSrv hosts centralized observability (Loki, Grafana, Prometheus)
#
# Setup Instructions:
# 1. Copy this file to promtail-config.yml
# 2. Update the Dell CoreSrv IP address in the clients URL below
# 3. Deploy using the docker-compose.yml in this directory
# 4. Ensure firewall allows traffic from NetSec Pi to Dell port 3100

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  # Dell CoreSrv Loki endpoint - UPDATE THIS IP!
  - url: http://192.168.8.100:3100/loki/api/v1/push

    # Batching configuration for efficiency
    batchwait: 1s
    batchsize: 1048576  # 1MB

    # Retry configuration for network resilience
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10

    # Timeout
    timeout: 10s

    # Optional: Add authentication if Loki requires it
    # basic_auth:
    #   username: <username>
    #   password: <password>

scrape_configs:
  # Suricata EVE JSON logs (IDS alerts and events)
  - job_name: suricata
    static_configs:
      - targets:
          - localhost
        labels:
          job: suricata
          service: suricata
          host: pi-netsec
          stack: netsec-ai
          component: ids
          __path__: /var/log/suricata/eve.json

    pipeline_stages:
      # Parse JSON
      - json:
          expressions:
            timestamp: timestamp
            event_type: event_type
            src_ip: src_ip
            dest_ip: dest_ip
            proto: proto
            alert_signature: alert.signature
            alert_severity: alert.severity
            alert_category: alert.category

      # Add timestamp
      - timestamp:
          source: timestamp
          format: RFC3339

      # Add parsed fields as labels for filtering
      - labels:
          event_type:
          alert_severity:

      # Optional: Drop non-alert events to reduce volume
      # Uncomment to only ship alerts, not flow/stats
      # - drop:
      #     source: event_type
      #     expression: "^(flow|stats|netflow)$"

  # Suricata Fast Log (alert summary)
  - job_name: suricata-fast
    static_configs:
      - targets:
          - localhost
        labels:
          job: suricata-fast
          host: pi-netsec
          stack: netsec-ai
          component: ids
          __path__: /var/log/suricata/fast.log

    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{2}/\d{2}/\d{4}-\d{2}:\d{2}:\d{2}\.\d+)\s+\[\*\*\]\s+\[(?P<gid>\d+):(?P<sid>\d+):(?P<rev>\d+)\]\s+(?P<signature>.*?)\s+\[\*\*\].*'

      - timestamp:
          source: timestamp
          format: '01/02/2006-15:04:05.000000'

  # AI Device Anomaly Detection logs
  - job_name: ai-device-anomaly
    static_configs:
      - targets:
          - localhost
        labels:
          job: ai-anomaly
          service: ai-device-anomaly
          host: pi-netsec
          stack: netsec-ai
          component: ai
          __path__: /var/log/ai-service/device-anomaly.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            device_ip: device_ip
            anomaly_score: anomaly_score
            window_start: window_start
            window_end: window_end
            features: features

      - timestamp:
          source: timestamp
          format: RFC3339

      # Optional: Only ship high-scoring anomalies
      # - match:
      #     selector: '{service="ai-device-anomaly"}'
      #     stages:
      #       - json:
      #           expressions:
      #             score: anomaly_score
      #       - drop:
      #           source: score
      #           expression: "^0\\.[0-4]"  # Drop scores < 0.4

  # AI Domain Risk Scoring logs
  - job_name: ai-domain-risk
    static_configs:
      - targets:
          - localhost
        labels:
          job: ai-risk
          service: ai-domain-risk
          host: pi-netsec
          stack: netsec-ai
          component: ai
          __path__: /var/log/ai-service/domain-risk.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            domain: domain
            risk_score: risk_score
            risk_factors: risk_factors
            first_seen: first_seen
            last_seen: last_seen

      - timestamp:
          source: timestamp
          format: RFC3339

      - labels:
          domain:

  # Threat Intel IOCs (Indicators of Compromise)
  - job_name: threat-intel-iocs
    static_configs:
      - targets:
          - localhost
        labels:
          job: threat-intel
          stream: intel_iocs
          host: pi-netsec
          stack: netsec-ai
          component: threat-intel
          __path__: /var/log/threat-intel/iocs.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            value: value
            ioc_type: ioc_type
            source: source
            confidence: confidence
            tags: tags
            first_seen: first_seen
            last_seen: last_seen

      - timestamp:
          source: timestamp
          format: RFC3339

      - labels:
          source:
          ioc_type:

  # Threat Intel Matches (IOCs found in environment)
  - job_name: threat-intel-matches
    static_configs:
      - targets:
          - localhost
        labels:
          job: threat-intel-match
          stream: intel_match
          host: pi-netsec
          stack: netsec-ai
          component: threat-intel
          __path__: /var/log/threat-intel/matches.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: match_time
            ioc_value: ioc_value
            ioc_type: ioc_type
            source: source
            device_ip: device_ip
            service: service
            confidence: confidence
            log_ref: log_ref

      - timestamp:
          source: timestamp
          format: RFC3339

      - labels:
          source:
          ioc_type:
          service:

  # Community Intel Digest
  - job_name: community-intel-digest
    static_configs:
      - targets:
          - localhost
        labels:
          job: community-intel
          stream: community_intel_digest
          host: pi-netsec
          stack: netsec-ai
          component: threat-intel
          __path__: /var/log/threat-intel/digest.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            time_range: time_range
            sources: sources
            keywords: keywords
            summary_markdown: summary_markdown

      - timestamp:
          source: timestamp
          format: RFC3339

  # Docker Container Logs (from NSM/AI stack containers)
  - job_name: docker-containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker
          host: pi-netsec
          stack: netsec-ai
          __path__: /var/lib/docker/containers/*/*.log

    pipeline_stages:
      # Parse Docker JSON log format
      - json:
          expressions:
            stream: stream
            log: log
            time: time

      - timestamp:
          source: time
          format: RFC3339Nano

      - output:
          source: log

      # Extract container ID from path
      - regex:
          expression: '^/var/lib/docker/containers/(?P<container_id>[^/]+)/.*'
          source: filename

      - labels:
          container_id:
          stream:

  # System Logs (for correlation and debugging)
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          host: pi-netsec
          stack: netsec-ai
          component: os
          __path__: /var/log/syslog

    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\S+\s+\S+\s+\S+)\s+(?P<hostname>\S+)\s+(?P<service>\S+)(\[(?P<pid>\d+)\])?:\s+(?P<message>.*)'

      - timestamp:
          source: timestamp
          format: 'Jan _2 15:04:05'

      - labels:
          hostname:
          service:

      # Filter out noise
      - match:
          selector: '{job="system"}'
          action: drop
          drop_counter_reason: "noisy_service"
          stages:
            - regex:
                expression: '(CRON|systemd|dbus)'
                source: service

# Resource limits for Raspberry Pi
limits_config:
  readline_rate: 10000
  readline_burst: 20000
