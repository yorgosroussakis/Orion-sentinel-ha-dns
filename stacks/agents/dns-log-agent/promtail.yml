# Promtail Configuration
# Collects and ships DNS logs to Loki on Security Pi

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: ${LOKI_URL}/loki/api/v1/push
    # Optional: Add authentication if Loki requires it
    # basic_auth:
    #   username: <username>
    #   password: <password>

scrape_configs:
  # Pi-hole Primary Logs
  - job_name: pihole-primary
    static_configs:
      - targets:
          - localhost
        labels:
          job: pihole
          instance: primary
          component: dns-blocker
          __path__: /var/log/pihole/primary/*.log

  # Pi-hole Secondary Logs
  - job_name: pihole-secondary
    static_configs:
      - targets:
          - localhost
        labels:
          job: pihole
          instance: secondary
          component: dns-blocker
          __path__: /var/log/pihole/secondary/*.log

  # Unbound Primary Logs
  - job_name: unbound-primary
    static_configs:
      - targets:
          - localhost
        labels:
          job: unbound
          instance: primary
          component: dns-resolver
          __path__: /var/log/unbound/primary/*.log

  # Unbound Secondary Logs
  - job_name: unbound-secondary
    static_configs:
      - targets:
          - localhost
        labels:
          job: unbound
          instance: secondary
          component: dns-resolver
          __path__: /var/log/unbound/secondary/*.log

  # Keepalived Logs (optional)
  - job_name: keepalived
    static_configs:
      - targets:
          - localhost
        labels:
          job: keepalived
          component: ha-manager
          __path__: /var/log/syslog
    pipeline_stages:
      - match:
          selector: '{job="keepalived"}'
          stages:
            - regex:
                expression: '.*Keepalived.*'
            - labels:
                stream: keepalived

  # System Logs (optional - for correlation)
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          component: os
          __path__: /var/log/syslog
    pipeline_stages:
      - match:
          selector: '{job="system"}'
          stages:
            - regex:
                expression: '^(?P<timestamp>\S+\s+\S+\s+\S+)\s+(?P<hostname>\S+)\s+(?P<service>\S+).*'
            - labels:
                hostname: hostname
                service: service
