services:
  backup:
    image: alpine:latest
    container_name: backup-service
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../../:/stack:ro
      - ../../backups:/backups
      - ../../scripts:/scripts:ro
    environment:
      - TZ=${TZ:-UTC}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-7}
      - BACKUP_DIR=/backups
      - STACK_ROOT=/stack
      - BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-0 2 * * *}
    command: |
      sh -c '
      apk add --no-cache docker-cli bash curl
      
      echo "════════════════════════════════════════════════════"
      echo "  Enhanced Backup Service Starting"
      echo "  Retention: $$BACKUP_RETENTION_DAYS days"
      echo "  Schedule: Daily at 2 AM (cron: $$BACKUP_SCHEDULE)"
      echo "════════════════════════════════════════════════════"
      
      # Initial backup on startup (after 60 seconds delay)
      (sleep 60 && bash /scripts/automated-backup.sh) &
      
      # Install crond
      echo "$$BACKUP_SCHEDULE bash /scripts/automated-backup.sh >> /backups/backup.log 2>&1" | crontab -
      
      echo "✓ Backup service configured"
      echo "✓ Running crond..."
      
      # Run crond in foreground
      crond -f -l 2
      '
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "crond"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

networks:
  default:
    driver: bridge
