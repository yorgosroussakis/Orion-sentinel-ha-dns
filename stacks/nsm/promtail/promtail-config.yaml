# Promtail Configuration for Orion Sentinel NSM Stack
# Collects logs from Suricata, AI service, and threat intel module

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    # Batching configuration for efficiency
    batchwait: 1s
    batchsize: 1048576  # 1MB
    
    # Retry configuration
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10
    
    # Timeout
    timeout: 10s

scrape_configs:
  # Suricata EVE JSON logs (IDS alerts and events)
  - job_name: suricata
    static_configs:
      - targets:
          - localhost
        labels:
          job: suricata
          service: suricata
          pi: pi2-security
          __path__: /var/log/suricata/eve.json
    
    pipeline_stages:
      # Parse JSON
      - json:
          expressions:
            timestamp: timestamp
            event_type: event_type
            src_ip: src_ip
            dest_ip: dest_ip
            proto: proto
            alert_signature: alert.signature
            alert_severity: alert.severity
            alert_category: alert.category
      
      # Add timestamp
      - timestamp:
          source: timestamp
          format: RFC3339
      
      # Add parsed fields as labels for filtering
      - labels:
          event_type:
          alert_severity:
      
      # Drop non-alert events (optional - comment out to keep all)
      # - drop:
      #     source: event_type
      #     expression: "^(flow|stats)$"

  # AI Device Anomaly Detection logs
  - job_name: ai-device-anomaly
    static_configs:
      - targets:
          - localhost
        labels:
          job: ai-anomaly
          service: ai-device-anomaly
          pi: pi2-security
          __path__: /var/log/ai-service/device-anomaly.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            device_ip: device_ip
            anomaly_score: anomaly_score
            window_start: window_start
            window_end: window_end
      
      - timestamp:
          source: timestamp
          format: RFC3339
      
      # Only include high anomaly scores (optional optimization)
      # - match:
      #     selector: '{service="ai-device-anomaly"}'
      #     stages:
      #       - json:
      #           expressions:
      #             score: anomaly_score
      #       - drop:
      #           source: score
      #           expression: "^0\\.[0-5]"  # Drop scores < 0.5

  # AI Domain Risk Scoring logs
  - job_name: ai-domain-risk
    static_configs:
      - targets:
          - localhost
        labels:
          job: ai-risk
          service: ai-domain-risk
          pi: pi2-security
          __path__: /var/log/ai-service/domain-risk.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            domain: domain
            risk_score: risk_score
            first_seen: first_seen
            last_seen: last_seen
      
      - timestamp:
          source: timestamp
          format: RFC3339

  # Threat Intel IOCs
  - job_name: threat-intel-iocs
    static_configs:
      - targets:
          - localhost
        labels:
          job: threat-intel
          stream: intel_iocs
          pi: pi2-security
          __path__: /var/log/threat-intel/iocs.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            value: value
            ioc_type: ioc_type
            source: source
            confidence: confidence
            tags: tags
            first_seen: first_seen
            last_seen: last_seen
      
      - timestamp:
          source: timestamp
          format: RFC3339
      
      - labels:
          source:
          ioc_type:

  # Threat Intel Matches (IOCs found in environment)
  - job_name: threat-intel-matches
    static_configs:
      - targets:
          - localhost
        labels:
          job: threat-intel-match
          stream: intel_match
          pi: pi2-security
          __path__: /var/log/threat-intel/matches.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: match_time
            ioc_value: ioc_value
            ioc_type: ioc_type
            source: source
            device_ip: device_ip
            service: service
            confidence: confidence
            log_ref: log_ref
      
      - timestamp:
          source: timestamp
          format: RFC3339
      
      - labels:
          source:
          ioc_type:
          service:

  # Community Intel Digest
  - job_name: community-intel-digest
    static_configs:
      - targets:
          - localhost
        labels:
          job: community-intel
          stream: community_intel_digest
          pi: pi2-security
          __path__: /var/log/threat-intel/digest.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            time_range: time_range
            sources: sources
            keywords: keywords
            summary_markdown: summary_markdown
            summary_text: summary_text
      
      - timestamp:
          source: timestamp
          format: RFC3339

  # Docker container logs (optional - for debugging)
  - job_name: docker
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker
          __path__: /var/lib/docker/containers/*/*.log
    
    pipeline_stages:
      # Parse Docker JSON format
      - json:
          expressions:
            stream: stream
            log: log
            time: time
      
      - timestamp:
          source: time
          format: RFC3339Nano
      
      - output:
          source: log
      
      # Extract container name from path
      - regex:
          expression: '^/var/lib/docker/containers/(?P<container_id>[^/]+)/.*'
          source: filename
      
      - labels:
          container_id:
          stream:

# Limits to prevent resource exhaustion on Raspberry Pi
limits_config:
  readline_rate: 10000
  readline_burst: 20000
