services:
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    environment:
      # Core configuration - Standard IDS Profile for 8GB Pi 5 (Recommended)
      - COLLECTIONS=crowdsecurity/linux crowdsecurity/nginx crowdsecurity/http-cve crowdsecurity/sshd
      # Enable metrics for Prometheus integration
      - DISABLE_ONLINE_API=false
      - LEVEL_TRACE=false
      - LEVEL_DEBUG=false
      - LEVEL_INFO=true
      # API configuration
      - ENROLL_KEY=${CROWDSEC_ENROLL_KEY:-}
      - ENROLL_INSTANCE_NAME=${CROWDSEC_INSTANCE_NAME:-rpi-ha-dns-stack}
      - ENROLL_TAGS=${CROWDSEC_TAGS:-raspberry-pi,dns,pihole}
    volumes:
      # Configuration
      - ./config:/etc/crowdsec
      - ./acquis:/etc/crowdsec/acquis.d:ro
      # Data persistence
      - crowdsec-db:/var/lib/crowdsec/data
      - crowdsec-config:/etc/crowdsec/local
      # Log sources - Pi-hole
      - /var/log/pihole:/var/log/pihole:ro
      # Log sources - System and Docker
      - /var/log:/var/log/host:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      # Log sources - SSH
      - /var/log/auth.log:/var/log/auth.log:ro
    ports:
      # API port
      - "8090:8080"
      # Prometheus metrics
      - "6060:6060"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - intrusion_detection_net
      - observability_net
    healthcheck:
      test: ["CMD", "cscli", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

volumes:
  crowdsec-db:
    driver: local
  crowdsec-config:
    driver: local

networks:
  intrusion_detection_net:
    driver: bridge
  observability_net:
    external: true
