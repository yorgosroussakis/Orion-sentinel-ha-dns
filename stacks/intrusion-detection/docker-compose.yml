services:
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    environment:
      # Core configuration
      - COLLECTIONS=crowdsecurity/linux crowdsecurity/nginx crowdsecurity/http-cve crowdsecurity/whitelist-good-actors crowdsecurity/sshd crowdsecurity/base-http-scenarios
      # Enable metrics for Prometheus integration
      - DISABLE_ONLINE_API=false
      - LEVEL_TRACE=false
      - LEVEL_DEBUG=false
      - LEVEL_INFO=true
      # API configuration
      - BOUNCER_KEY_FIREWALL=${CROWDSEC_BOUNCER_KEY_FIREWALL}
      - ENROLL_KEY=${CROWDSEC_ENROLL_KEY:-}
      - ENROLL_INSTANCE_NAME=${CROWDSEC_INSTANCE_NAME:-rpi-ha-dns-stack}
      - ENROLL_TAGS=${CROWDSEC_TAGS:-raspberry-pi,dns,pihole}
    volumes:
      # Configuration
      - ./config:/etc/crowdsec
      - ./acquis:/etc/crowdsec/acquis.d:ro
      # Data persistence
      - crowdsec-db:/var/lib/crowdsec/data
      - crowdsec-config:/etc/crowdsec/local
      # Log sources - Pi-hole
      - /var/log/pihole:/var/log/pihole:ro
      # Log sources - System and Docker
      - /var/log:/var/log/host:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      # Log sources - SSH
      - /var/log/auth.log:/var/log/auth.log:ro
    ports:
      # API port for bouncers
      - "8090:8080"
      # Prometheus metrics
      - "6060:6060"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - intrusion_detection_net
      - observability_net
    healthcheck:
      test: ["CMD", "cscli", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  crowdsec-firewall-bouncer:
    image: crowdsecurity/cs-firewall-bouncer:latest
    container_name: crowdsec-firewall-bouncer
    environment:
      - CROWDSEC_LAPI_URL=http://crowdsec:8080
      - CROWDSEC_LAPI_KEY=${CROWDSEC_BOUNCER_KEY_FIREWALL}
      - DISABLE_IPV6=false
      - IPTABLES_CHAINS=INPUT,FORWARD
      - NFTABLES_ENABLED=true
      - IPTABLES_ENABLED=true
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    depends_on:
      - crowdsec
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "pgrep", "-f", "cs-firewall-bouncer"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M

  # Optional: Nginx bouncer for protecting web services
  # Uncomment if you're running Nginx Proxy Manager or other web services
  # crowdsec-nginx-bouncer:
  #   image: fbonalair/traefik-crowdsec-bouncer:latest
  #   container_name: crowdsec-nginx-bouncer
  #   environment:
  #     - CROWDSEC_BOUNCER_API_KEY=${CROWDSEC_BOUNCER_KEY_NGINX}
  #     - CROWDSEC_AGENT_HOST=crowdsec:8080
  #   restart: unless-stopped
  #   depends_on:
  #     - crowdsec
  #   networks:
  #     - intrusion_detection_net
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.25'
  #         memory: 64M
  #       reservations:
  #         cpus: '0.05'
  #         memory: 16M

volumes:
  crowdsec-db:
    driver: local
  crowdsec-config:
    driver: local

networks:
  intrusion_detection_net:
    driver: bridge
  observability_net:
    external: true
