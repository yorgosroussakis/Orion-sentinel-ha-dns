# SSO Stack with Authelia and OAuth2 Proxy
# Provides Single Sign-On for all services

services:
  # Authelia - Authentication and Authorization Server
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    hostname: authelia
    volumes:
      - ./authelia:/config
    ports:
      - "9091:9091"
    environment:
      - TZ=${TZ:-Europe/Amsterdam}
      - AUTHELIA_JWT_SECRET_FILE=/config/secrets/jwt_secret
      - AUTHELIA_SESSION_SECRET_FILE=/config/secrets/session_secret
      - AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE=/config/secrets/storage_encryption_key
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9091/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    networks:
      - sso_net
      - dns_net
      - observability_net

  # OAuth2 Proxy - For services that don't support native OAuth2
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: oauth2-proxy
    hostname: oauth2-proxy
    command:
      - --http-address=0.0.0.0:4180
      - --provider=oidc
      - --provider-display-name=Authelia
      - --oidc-issuer-url=http://authelia:9091
      - --redirect-url=http://${HOST_IP:-192.168.8.250}:4180/oauth2/callback
      - --cookie-secret=${OAUTH2_COOKIE_SECRET}
      - --cookie-secure=false
      - --cookie-domain=${HOST_IP:-192.168.8.250}
      - --whitelist-domain=.${HOST_IP:-192.168.8.250}
      - --email-domain=*
      - --upstream=static://202
      - --skip-provider-button=true
    ports:
      - "4180:4180"
    environment:
      - OAUTH2_PROXY_CLIENT_ID=${OAUTH2_CLIENT_ID:-authelia}
      - OAUTH2_PROXY_CLIENT_SECRET=${OAUTH2_CLIENT_SECRET}
    depends_on:
      - authelia
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    networks:
      - sso_net

  # Redis - For Authelia session storage (optional but recommended)
  redis:
    image: redis:alpine
    container_name: authelia-redis
    hostname: authelia-redis
    volumes:
      - redis-data:/data
    command: redis-server --save 60 1 --loglevel warning
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    networks:
      - sso_net

networks:
  sso_net:
    driver: bridge
  dns_net:
    external: true
  observability_net:
    external: true

volumes:
  redis-data:
    driver: local
