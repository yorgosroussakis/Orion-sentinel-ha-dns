version: "3.8"

# ===================================================================
# WireGuard VPN Front Door for HA DNS Stack
# ===================================================================
# This adds WireGuard VPN access that integrates with your existing
# HA DNS infrastructure using the VIP (192.168.8.255) for DNS.
#
# Architecture:
#   Internet → Router:51820/udp → Pi → WireGuard → VPN Clients
#                                           ↓
#                                       VIP DNS (192.168.8.255)
#                                           ↓
#                                   Pi-hole HA (251/252) + Unbound (253/254)
#
# Deploy: docker compose -f docker-compose.vpn.yml --env-file .env.vpn up -d
# ===================================================================

services:
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    hostname: wireguard
    
    # Host networking for direct access to LAN and VIP
    # This allows VPN clients to reach 192.168.8.255 directly
    network_mode: "host"
    
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Amsterdam}
      
      # Server configuration
      - SERVERURL=${WG_HOST}
      - SERVERPORT=${WG_PORT:-51820}
      - PEERS=${WG_PEERS:-3}
      - PEERDNS=${WG_PEER_DNS:-192.168.8.255}
      - INTERNAL_SUBNET=${WG_SUBNET:-10.6.0.0}
      - ALLOWEDIPS=${WG_ALLOWEDIPS:-192.168.8.0/24,10.6.0.0/24}
      
      # Generate QR codes for easy phone setup
      - LOG_CONFS=true
      
      # Optional: Persistent keepalive for NAT traversal
      - PERSISTENTKEEPALIVE_PEERS=${WG_PERSISTENT_KEEPALIVE:-25}
    
    volumes:
      - ${WG_CONFIG_DIR:-./wireguard/config}:/config
      - /lib/modules:/lib/modules:ro
    
    sysctls:
      # Enable IP forwarding for VPN routing
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "test", "-f", "/config/wg_confs/wg0.conf"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # WireGuard-UI: Web interface for managing VPN peers with QR codes
  wireguard-ui:
    image: ngoduykhanh/wireguard-ui:latest
    container_name: wireguard-ui
    hostname: wireguard-ui
    
    depends_on:
      - wireguard
    
    # Share network stack with wireguard container
    # UI will be accessible on http://192.168.8.250:5000
    network_mode: "service:wireguard"
    
    cap_add:
      - NET_ADMIN
    
    environment:
      - SESSION_SECRET=${WGUI_SESSION_SECRET:-ChangeThisRandomSessionSecret}
      - WGUI_USERNAME=${WGUI_USERNAME:-admin}
      - WGUI_PASSWORD=${WGUI_PASSWORD:-ChangeThisPassword}
      - WGUI_ENDPOINT_ADDRESS=${WG_HOST}
      - WGUI_DNS=${WG_PEER_DNS:-192.168.8.255}
      - WGUI_MTU=${WG_MTU:-1420}
      - WGUI_PERSISTENT_KEEPALIVE=${WG_PERSISTENT_KEEPALIVE:-25}
      - WGUI_MANAGE_START=true
      - WGUI_MANAGE_RESTART=true
      - WGUI_CONFIG_FILE_PATH=/config/wg_confs/wg0.conf
    
    volumes:
      # UI database
      - ${WG_CONFIG_DIR:-./wireguard/config}/db:/app/db
      # Share WireGuard config folder for peer management
      - ${WG_CONFIG_DIR:-./wireguard/config}:/config
    
    restart: unless-stopped
    
    logging:
      driver: json-file
      options:
        max-size: 50m
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    
    profiles:
      - ui

# ===================================================================
# Usage:
# ===================================================================
# 
# Deploy WireGuard only:
#   docker compose -f docker-compose.vpn.yml --env-file .env.vpn up -d
#
# Deploy with Web UI (RECOMMENDED for easy QR code access):
#   docker compose -f docker-compose.vpn.yml --env-file .env.vpn --profile ui up -d
#
# View logs:
#   docker logs wireguard
#   docker logs wireguard-ui
#
# Access WireGuard-UI:
#   http://192.168.8.250:5000
#   Login with WGUI_USERNAME and WGUI_PASSWORD from .env.vpn
#
# QR codes for mobile:
#   - Via UI: http://192.168.8.250:5000 (easiest!)
#   - Via files: ls wireguard/config/peer_*/peer_*.png
#
# Test VPN connection:
#   1. Connect to VPN from your device
#   2. ping 192.168.8.255 (should work!)
#   3. nslookup google.com 192.168.8.255 (DNS test)
#   4. Open http://192.168.8.251/admin (Pi-hole admin)
#
# ===================================================================
