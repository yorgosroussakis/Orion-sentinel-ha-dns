# Production-Ready 2-Pi DNS HA Stack - Node 1 (PRIMARY)
# This deployment provides hardware-level redundancy with automatic VIP failover
#
# Architecture:
#   Pi #1 (Primary): Pi-hole + Unbound + Keepalived (MASTER)
#   Pi #2 (Secondary): Pi-hole + Unbound + Keepalived (BACKUP)
#   VIP floats between nodes based on health and priority
#
# Deploy with: docker compose up -d

services:
  # =============================================================================
  # Pi-hole - Network-wide Ad Blocking (Primary Instance)
  # =============================================================================
  pihole_primary:
    image: pihole/pihole:latest
    container_name: pihole_primary
    hostname: pihole-primary
    environment:
      - TZ=${TZ:-Europe/London}
      - WEBPASSWORD=${PIHOLE_PASSWORD:?PIHOLE_PASSWORD must be set}
      - PIHOLE_DNS_=${UNBOUND_PRIMARY_IP:-192.168.8.253}#5335
      - FTLCONF_LOCAL_IPV4=${PIHOLE_PRIMARY_IP:-192.168.8.251}
      - DNSMASQ_LISTENING=all
      - WEBTHEME=${PIHOLE_THEME:-default-dark}
    networks:
      dns_net:
        ipv4_address: ${PIHOLE_PRIMARY_IP:-192.168.8.251}
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "80:80/tcp"
    restart: unless-stopped
    volumes:
      - pihole_config:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "-p", "53", "pi.hole", "+short", "+time=2"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      unbound_primary:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    cap_add:
      - NET_ADMIN
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # Unbound - Recursive DNS Resolver with DNSSEC (Primary Instance)
  # =============================================================================
  unbound_primary:
    image: mvance/unbound-rpi:latest
    container_name: unbound_primary
    hostname: unbound-primary
    networks:
      dns_net:
        ipv4_address: ${UNBOUND_PRIMARY_IP:-192.168.8.253}
    restart: unless-stopped
    volumes:
      - ./unbound/unbound.conf:/opt/unbound/etc/unbound/unbound.conf:ro
      - unbound_data:/opt/unbound/etc/unbound/var
    healthcheck:
      test: ["CMD", "drill", "@127.0.0.1", "-p", "5335", "cloudflare.com"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # Keepalived - VIP Management and Failover (MASTER)
  # =============================================================================
  keepalived:
    build:
      context: ./keepalived
      dockerfile: Dockerfile
    container_name: keepalived
    hostname: keepalived-primary
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_BROADCAST
      - NET_RAW
    volumes:
      - ./keepalived/keepalived.conf:/etc/keepalived/keepalived.conf:ro
      - ./keepalived/check_dns.sh:/etc/keepalived/check_dns.sh:ro
      - ./keepalived/notify_master.sh:/etc/keepalived/notify_master.sh:ro
      - ./keepalived/notify_backup.sh:/etc/keepalived/notify_backup.sh:ro
      - ./keepalived/notify_fault.sh:/etc/keepalived/notify_fault.sh:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - NODE_ROLE=MASTER
      - NODE_PRIORITY=${KEEPALIVED_PRIORITY:-100}
      - NODE_IP=${NODE_IP:-192.168.8.11}
      - PEER_IP=${PEER_IP:-192.168.8.12}
      - VIP_ADDRESS=${VIP_ADDRESS:-192.168.8.255}
      - VIRTUAL_ROUTER_ID=${VIRTUAL_ROUTER_ID:-51}
      - VRRP_PASSWORD=${VRRP_PASSWORD:?VRRP_PASSWORD must be set}
      - NETWORK_INTERFACE=${NETWORK_INTERFACE:-eth0}
      - PIHOLE_IP=${PIHOLE_PRIMARY_IP:-192.168.8.251}
      - NOTIFY_ON_FAILOVER=${NOTIFY_ON_FAILOVER:-true}
      - NOTIFY_ON_FAILBACK=${NOTIFY_ON_FAILBACK:-true}
      - ALERT_WEBHOOK=${ALERT_WEBHOOK:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-x", "keepalived"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # =============================================================================
  # Pi-hole Sync - Configuration Synchronization to Secondary Node
  # =============================================================================
  pihole-sync:
    image: alpine:latest
    container_name: pihole-sync
    hostname: pihole-sync-primary
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../../../../scripts/pihole-v6-sync.sh:/sync.sh:ro
      - pihole_config:/etc/pihole:ro
      - sync_ssh:/root/.ssh
    command: >
      sh -c "
        apk add --no-cache docker-cli bash openssh-client rsync curl jq &&
        chmod +x /sync.sh &&
        while true; do
          echo '[$(date)] Running Pi-hole sync to secondary node...'
          bash /sync.sh || echo '[$(date)] Sync failed, will retry...'
          sleep ${SYNC_INTERVAL:-300}
        done
      "
    environment:
      - SYNC_INTERVAL=${SYNC_INTERVAL:-300}
      - PRIMARY_PIHOLE_CONTAINER=pihole_primary
      - SECONDARY_HOST=${PEER_IP:-192.168.8.12}
      - SECONDARY_PIHOLE_CONTAINER=pihole_secondary
      - SYNC_GRAVITY=${SYNC_GRAVITY:-true}
      - SYNC_CUSTOM=${SYNC_CUSTOM:-true}
      - SYNC_WHITELIST=${SYNC_WHITELIST:-true}
      - SYNC_BLACKLIST=${SYNC_BLACKLIST:-true}
    restart: unless-stopped
    depends_on:
      - pihole_primary
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =============================================================================
  # Self-Healing Service - Automated Recovery and Maintenance
  # =============================================================================
  self-healing:
    image: alpine:latest
    container_name: self-healing
    hostname: self-healing-primary
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../../../../scripts/complete-self-healing.sh:/self-healing.sh:ro
      - ./logs:/var/log/self-healing
      - ./backups:/backup
    command: >
      sh -c "
        apk add --no-cache docker-cli bash bind-tools curl bc sqlite jq &&
        chmod +x /self-healing.sh &&
        bash /self-healing.sh
      "
    environment:
      - CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-60}
      - MAX_RESTART_ATTEMPTS=${MAX_RESTART_ATTEMPTS:-3}
      - RESTART_COOLDOWN=${RESTART_COOLDOWN:-300}
      - TEST_DOMAIN=${TEST_DOMAIN:-google.com}
      - DISK_USAGE_THRESHOLD=${DISK_USAGE_THRESHOLD:-85}
      - MEMORY_USAGE_THRESHOLD=${MEMORY_USAGE_THRESHOLD:-90}
      - LOG_MAX_SIZE_MB=${LOG_MAX_SIZE_MB:-100}
      - BACKUP_DIR=/backup
      - RETENTION_DAYS=${RETENTION_DAYS:-30}
      - ALERT_WEBHOOK=${ALERT_WEBHOOK:-}
      - DNS_CONTAINERS=pihole_primary,unbound_primary
    restart: unless-stopped
    depends_on:
      - pihole_primary
      - unbound_primary
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =============================================================================
  # Automated Backup Service
  # =============================================================================
  auto-backup:
    image: alpine:latest
    container_name: auto-backup
    hostname: auto-backup-primary
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../../../../scripts/pihole-auto-backup.sh:/backup.sh:ro
      - ./backups:/backup
      - pihole_config:/etc/pihole:ro
    command: >
      sh -c "
        apk add --no-cache docker-cli bash sqlite tar gzip &&
        chmod +x /backup.sh &&
        while true; do
          echo '[$(date)] Running automated backup...'
          bash /backup.sh || echo '[$(date)] Backup failed!'
          sleep ${BACKUP_INTERVAL:-86400}
        done
      "
    environment:
      - BACKUP_INTERVAL=${BACKUP_INTERVAL:-86400}
      - RETENTION_DAYS=${RETENTION_DAYS:-30}
      - PIHOLE_CONTAINERS=pihole_primary
      - BACKUP_DIR=/backup
    restart: unless-stopped
    depends_on:
      - pihole_primary
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# =============================================================================
# Networks
# =============================================================================
networks:
  dns_net:
    driver: macvlan
    driver_opts:
      parent: ${NETWORK_INTERFACE:-eth0}
    ipam:
      config:
        - subnet: ${SUBNET:-192.168.8.0/24}
          gateway: ${GATEWAY:-192.168.8.1}
          ip_range: ${IP_RANGE:-192.168.8.240/28}

# =============================================================================
# Volumes
# =============================================================================
volumes:
  pihole_config:
    driver: local
  pihole_dnsmasq:
    driver: local
  unbound_data:
    driver: local
  sync_ssh:
    driver: local
