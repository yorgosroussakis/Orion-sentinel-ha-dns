# Production-Ready Keepalived Configuration for PRIMARY Node
# 2-Pi DNS HA Architecture with VIP Failover
#
# This node will be the MASTER under normal conditions.
# VIP will float to the secondary node if this node fails health checks.

global_defs {
    router_id DNS_HA_PRIMARY
    enable_script_security
    script_user root
    
    # Gratuitous ARP configuration for fast failover
    vrrp_garp_master_refresh 60
    vrrp_garp_master_repeat 3
    vrrp_garp_master_refresh_repeat 2
    
    # Skip interface checks (useful for containers)
    vrrp_skip_check_adv_addr
    
    # Enable strict checking of VRRP packets
    vrrp_strict
    
    # Logging
    log_unknown_vrids
}

# Health check script to verify local DNS services are operational
vrrp_script check_dns {
    script "/etc/keepalived/check_dns.sh"
    interval 5          # Check every 5 seconds
    timeout 3           # Script timeout
    weight -30          # Reduce priority by 30 if check fails
    fall 3              # Require 3 failures before marking as failed
    rise 2              # Require 2 successes before marking as recovered
    user root
}

# VRRP instance for DNS High Availability VIP
vrrp_instance VI_DNS {
    # Initial state - Primary starts as MASTER
    state MASTER
    
    # Network interface to bind VIP to
    interface eth0
    
    # Virtual Router ID (must be same on both nodes, 1-255)
    virtual_router_id 51
    
    # Priority (higher = more likely to be MASTER)
    # Primary: 100, Secondary: 90
    priority 100
    
    # Advertisement interval in seconds
    advert_int 1
    
    # Preempt mode - allow this node to take over when it recovers
    preempt_delay 30    # Wait 30 seconds before preempting
    
    # Authentication between VRRP peers
    authentication {
        auth_type PASS
        auth_pass vrrp_secret
    }
    
    # Virtual IP address (the floating IP for DNS)
    virtual_ipaddress {
        192.168.8.255/24 dev eth0 label eth0:vip
    }
    
    # Use unicast communication (recommended for most networks)
    unicast_src_ip 192.168.8.11
    unicast_peer {
        192.168.8.12
    }
    
    # Track the DNS health check script
    track_script {
        check_dns
    }
    
    # Notification scripts for state transitions
    notify_master "/etc/keepalived/notify_master.sh VI_DNS MASTER"
    notify_backup "/etc/keepalived/notify_backup.sh VI_DNS BACKUP"
    notify_fault  "/etc/keepalived/notify_fault.sh VI_DNS FAULT"
    
    # Send gratuitous ARP on state changes
    garp_master_delay 1
    garp_master_repeat 3
    garp_master_refresh 60
}
