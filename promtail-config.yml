# =============================================================================
# Promtail Configuration for Orion Sentinel HA DNS
# =============================================================================
# Ships Pi-hole DNS logs to Loki (CoreServices/SPoG integration)
# Configure LOKI_URL in your .env file
# =============================================================================

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  # Loki endpoint - configure via LOKI_URL environment variable
  # Example: http://192.168.8.100:3100/loki/api/v1/push
  - url: ${LOKI_URL:-http://localhost:3100/loki/api/v1/push}

scrape_configs:
  # Pi-hole query logs
  - job_name: pihole
    static_configs:
      - targets:
          - localhost
        labels:
          job: pihole
          service: dns
          node: ${NODE_NAME:-orion-dns}
          __path__: /var/log/pihole/*.log

    pipeline_stages:
      # Parse Pi-hole log format
      - match:
          selector: '{job="pihole"}'
          stages:
            - regex:
                expression: '^(?P<timestamp>\w{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2})\s+dnsmasq\[\d+\]:\s+(?P<action>query|forwarded|reply|cached)\[(?P<type>\w+)\]\s+(?P<domain>\S+)\s+(?P<details>.*)$'
            - labels:
                action:
                type:
            - timestamp:
                source: timestamp
                format: 'Jan _2 15:04:05'
